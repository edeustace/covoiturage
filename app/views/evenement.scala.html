@import helper._
@import helper.twitterBootstrap._


@main(Messages("playauthenticate.event.title"),"event") {
    <link rel="stylesheet" media="screen" href="@routes.Assets.at("css/demo.css")" />
    <link href="@routes.Assets.at("css/bootstrap-datepicker.css")" rel="stylesheet" />
    <link href="@routes.Assets.at("css/bootstrap-timepicker.css")" rel="stylesheet" />

    <script src="http://maps.googleapis.com/maps/api/js?libraries=places&sensor=false&language=fr"></script>
    <script src="http://cdn.sockjs.org/sockjs-0.3.min.js"></script>

    <script type="text/javascript" src="@routes.Assets.at("js/lib/angular.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/ui-bootstrap-tpls-0.4.0.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/event.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/keypress.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/ui-map.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/angular-strap.min.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/bootstrap-datepicker.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/bootstrap-timepicker.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/directives/googleplace.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/modules/mailUtils.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/modules/eventService.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/modules/mapService.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/event/app.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/event/controller.js")"></script>
    <script type="text/javascript" src="@routes.Assets.at("js/app/filters.js")"></script>
    <script type="text/javascript" src="@routes.Application.jsRoutes()"></script>



    <div ng-controller="EventCtrl" ng-app="covoiturage">

        <div class="row-fluid" >
            <div class="span2">
            </div>
            <div class="span4">
                <div ng-show="!eventEdit">
                    <h1>
                    {{event.name}}
                    </h1>
                    <p >
                    Le <strong>{{event.fromDate | date:'dd-MM-yyyy'}}</strong> <strong ng-show="event.startTime">à {{event.startTime}}</strong>
                    <address>à  {{event.address.description}}</address>
                    </p>
                    <accordion>
                        <accordion-group heading="Plus d'informations ..." >
                            <dl>
                                <dt>Description de l'événement :</dt>
                                <dd>
                                    <p class="text-rigth">
                                    {{event.description}}
                                    </p>
                                </dd>
                                <dt >Liste de diffusion : </dt>
                                <dd>
                                    <ul>
                                        <li ng-repeat="contact in event.contacts" >{{contact}}</li>
                                    </ul>
                                    <div class="controls">
                                        <div class="input-prepend input-append" ng-show="showEventEditButton">
                                            <span class="add-on"><i class="icon-envelope"></i></span>
                                            <input ng-model="contacts.addedContact" placeholder="email1;email2..." type="text"></input>
                                            <button class="btn" type="button"  ng-click="addContact(contacts.addedContact)">Ajouter</button>
                                        </div>
                                    </div>
                                    <button class="btn" type="button"  ng-show="!event.contactsOnly && showEventEditButton" ng-click="securise()" tooltip-placement="right" tooltip="L'évenement sera restreint à la liste de diffusion">Sécuriser cet évenement</button>
                                    <button class="btn" type="button"  ng-show="event.contactsOnly && showEventEditButton" ng-click="unSecurise()">Ne plus sécuriser cet évenement</button>
                                </dd>
                            </dl>
                        </accordion-group>
                    </accordion>


                    <button ng-show="showEventEditButton" class="btn" type="button" ng-click="setEventEditMode(true)">Editer</button>



                </div>
                <div ng-show="eventEdit">
                    <div class="alert alert-info" ng-show="showUpdated">
                        <button type="button" class="close" data-dismiss="alert" ng-click="setToUpdated()">&times;</button>
                        Completez les informations de l'événement pour aider les participants !
                    </div>
                    <label>Nom</label>
                    <input ng-model="event.name" type="text" ></input>
                    <label>Description</label>
                    <textarea ng-model="event.description" rows="3" cols="8"></textarea>
                    <label>Date de l'événement</label>
                    <div class="control-group input-append">
                        <input type="text" ng-model="event.fromDate" data-date-format="dd/mm/yyyy" bs-datepicker>
                        <button type="button" class="btn" data-toggle="datepicker"><i class="icon-calendar"></i></button>
                    </div>
                    <label>Heure de début</label>
                    <div class="control-group input-append">
                        <input type="text" ng-model="event.startTime" bs-timepicker>
                        <button type="button" class="btn" data-toggle="timepicker"><i class="icon-time"></i></button>
                    </div>
                    <label>Adresse de l'évenement :</label>
                    <input ng-model="event.address" googleplace type="text" ></input>

                    <label>Liste de diffusion :</label>
                    <div class="controls">
                        <div class="input-prepend input-append" >
                            <span class="add-on"><i class="icon-envelope"></i></span>
                            <input ng-model="contacts.addedContact" placeholder="email1;email2..." type="text"></input>
                            <button class="btn" type="button"  ng-click="addContact(contacts.addedContact)">Ajouter</button>
                        </div>
                    </div>
                    <button class="btn" type="button"  ng-show="!event.contactsOnly" ng-click="securise()" tooltip-placement="right" tooltip="L'évenement sera restreint à la liste de diffusion">Sécuriser cet évenement</button>
                    <button class="btn" type="button"  ng-show="event.contactsOnly" ng-click="unSecurise()">Ne plus sécuriser cet évenement</button>
                    <br/>
                    <button class="btn btn-primary" type="button" ng-click="saveEvent()">Valider</button>
                    <button class="btn" type="button" ng-click="setEventEditMode(false)">Annuler</button>
                </div>



                <alert ng-repeat="alert in alerts | orderBy: '-date' " type="alert.type" close="closeAlert($index)">{{alert.msg}}</alert>
                <br/>
                    <div ng-repeat="marker in myMarkers" ui-map-marker="myMarkers[$index]"
                         ui-event="{'map-click': 'openMarkerInfo(marker)'}">
                    </div>
                    <div ui-map-info-window="myInfoWindow">
                            <strong>{{currentInfoWindowsSubscriber.surname}} {{currentInfoWindowsSubscriber.name}}</strong>
                            <div ng-show="currentInfoWindowsSubscriber.locomotion == 'CAR'">
                                Passagers :
                                <ul>
                                    <li ng-repeat="aPassenger in currentInfoWindowsSubscriber.car.passengers" >
                                        {{refSubscribers[aPassenger].surname}} {{refSubscribers[aPassenger].name}}
                                    </li>
                                </ul>
                                {{currentInfoWindowsSubscriber.car.nbPlaces - currentInfoWindowsSubscriber.car.passengers.length}} places restantes
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && currentInfoWindowsSubscriber.normalCar" >
                                <button class="btn btn-success btn-mini" type="button" ng-click="askForSeat(currentInfoWindowsSubscriber)" >Monter</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && currentInfoWindowsSubscriber.currentCar" >
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removePassenger(currentInfoWindowsSubscriber, currentSubscriber.userRef)" >Descendre</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && currentInfoWindowsSubscriber.iAskHim" >
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removeWaitingGuy(currentInfoWindowsSubscriber, currentSubscriber.userRef)" >Descendre</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && currentInfoWindowsSubscriber.heAskMeToBeInHisCar">
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removePossibleCar(currentSubscriber, currentInfoWindowsSubscriber.userRef)" >Descendre</button>
                            </div>
                            <!-- AUTOSTOP -->
                            <div ng-show="currentSubscriber.locomotion == 'CAR' && currentInfoWindowsSubscriber.free">
                                <button class="btn btn-success btn-mini" type="button" ng-click="proposeSeat(currentInfoWindowsSubscriber, currentSubscriber.userRef)" >Prendre</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'CAR' && currentInfoWindowsSubscriber.requestedByMe">
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removePossibleCar(currentInfoWindowsSubscriber, currentSubscriber.userRef)" >Ne plus prendre</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'CAR' && currentInfoWindowsSubscriber.waitingForMyCar">
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removeWaitingGuy(currentSubscriber, currentInfoWindowsSubscriber.userRef)" >Ne plus prendre</button>
                            </div>
                            <div ng-show="currentSubscriber.locomotion == 'CAR' && currentInfoWindowsSubscriber.inMyCar">
                                <button class="btn btn-warning btn-mini" type="button" ng-click="removePassenger(currentSubscriber, currentInfoWindowsSubscriber.userRef)" >Ne plus prendre</button>
                            </div>
                    </div>
                    <div id="map_canvas" ui-map="myMap" class="map"
                         ui-options="mapOptions">
                    </div>
            </div>
            <div ng-show="!currentSubscriber"  class="span4">
                <fieldset>
                    <legend>Vous ne participez pas encore :</legend>
                    <label>Email</label>
                    <input ng-model="newSubscriber.email" type="email" required></input>
                    <label>Nom</label>
                    <input ng-model="newSubscriber.name" type="text" ></input>
                    <label>Prénom</label>
                    <input ng-model="newSubscriber.surname" type="text" ></input>
                    <label>Point de départ</label>
                    <input ng-model="newSubscriber.address" googleplace type="text" ></input>
                    <label>Je suis :</label>
                    <select ng-model="newSubscriber.locomotion" ng-options="item.id as item.name for item in items"></select>
                    <div ng-show="newSubscriber.locomotion == 'CAR'">
                        <label>Nb passagers max</label>
                        <input ng-model="newSubscriber.car.nbPlaces" type="text" maxlength="1"></input>
                    </div>
                </fieldset>
                <button class="btn btn-primary" type="button" ng-click="subscribe()">Participer</button>
            </div>

            <div ng-show="currentSubscriber" class="span4">
                <br/>


                <div>
                    <h3>{{currentSubscriber.surname}} {{currentSubscriber.name}}</h3>
                    <strong>Mon point de départ : </strong>

                    <address ng-show="!editMode">
                      <i class="icon-globe"></i> {{currentSubscriber.address.description}} <button class="btn" ng-show="!editMode" ng-click="setEditMode(true)">Modifier</button>
                    </address>

                    <div ng-show="editMode" >
                        <label>Nouvelle adresse : </label>
                        <div class="input-prepend">
                            <span class="add-on"><i class="icon-globe"></i></span>
                            <input ng-model="currentSubscriber.address" googleplace type="text" ></input>
                        </div>
                        <button  class="btn btn-primary" ng-click="saveCurrentSubscriber()">Valider</button>
                        <button  class="btn" ng-click="setEditMode(false)">Annuler</button>
                    </div>



                    <div ng-show="currentSubscriber.locomotion == 'AUTOSTOP'">
                        <div ng-show="currentSubscriber.carRef" class="well">
                            <strong>Ma voiture :</strong>
                            {{refSubscribers[currentSubscriber.carRef].surname}} {{refSubscribers[currentSubscriber.carRef].name}}
                            <button class="btn btn-warning btn-mini" type="button" ng-click="removePassenger(refSubscribers[currentSubscriber.carRef], currentSubscriber.userRef)" >Annuler</button>
                        </div>
                        <div ng-show="!currentSubscriber.carRef">
                            <strong>Mes demandes en attente :</strong>
                            <ul>
                                <li ng-repeat="subscriber in subscribers" ng-show="subscriber.iAskHim">
                                    {{subscriber.surname}} {{subscriber.name}}
                                    <button class="btn btn-warning btn-mini" type="button" ng-click="removeWaitingGuy(subscriber, currentSubscriber.userRef)" >Annuler</button>
                                </li>
                            </ul>
                            <strong ng-show="currentSubscriber.possibleCars.length > 0">Les utilisateurs suivants me proposent leur voiture :</strong>
                            <ul >
                                <li ng-repeat="subscriber in subscribers" ng-show="subscriber.heAskMeToBeInHisCar">
                                    {{subscriber.surname}} {{subscriber.name}}
                                    <button class="btn btn-success btn-mini" type="button" ng-click="validatePassenger(subscriber, currentSubscriber.userRef)" >Accepter</button>
                                    <button class="btn btn-warning btn-mini" type="button" ng-click="removePossibleCar(currentSubscriber, subscriber.userRef)" >Refuser</button>
                                </li>
                            </ul>
                        </div>

                    </div>
                    <div ng-show="currentSubscriber.locomotion == 'CAR'">
                        <div ng-show="currentSubscriber.car &&  currentSubscriber.car.passengers" class="well">
                            <label>Les passagers de ma voiture : </label>
                            <ul>
                                <li ng-repeat="passenger in currentSubscriber.car.passengers" >
                                    {{refSubscribers[passenger].surname}} {{refSubscribers[passenger].name}}
                                    <button class="btn btn-warning btn-mini" type="button" ng-click="removePassenger(currentSubscriber, passenger)" >Supprimer</button>
                                </td>
                                </li>
                            </ul>
                            {{currentSubscriber.car.nbPlaces - currentSubscriber.car.passengers.length}} places restantes
                        </div>
                        <div ng-show="currentSubscriber.car &&  currentSubscriber.car.waitings">
                            <strong>En attente : </strong>
                            <ul>
                                <li ng-repeat="passenger in currentSubscriber.car.waitings" >
                                    {{refSubscribers[passenger].surname}} {{refSubscribers[passenger].name}}
                                    <button class="btn btn-success btn-mini" type="button" ng-click="validatePassenger(currentSubscriber, passenger)" >Valider</button>
                                    <button class="btn btn-warning btn-mini" type="button" ng-click="removeWaitingGuy(currentSubscriber, passenger)" >Annuler</button>
                                </li>
                            </ul>
                        </div>
                        <div >
                            <strong>Mes propositions : </strong>
                            <ul>
                                <li ng-repeat="subscriber in subscribers" ng-show="subscriber.requestedByMe">
                                    {{subscriber.surname}} {{subscriber.name}}
                                    <button class="btn btn-warning btn-mini" type="button" ng-click="removePossibleCar(subscriber, currentSubscriber.userRef)" >Annuler</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <br/>
                    <span><strong>Afficher : </strong></span>
                    <br/>
                     <div class="btn-group">
                        <button type="button" class="btn btn-primary" ng-model="filterUsers" btn-radio="'CAR'">Les conducteurs</button>
                        <button type="button" class="btn btn-primary" ng-model="filterUsers" btn-radio="'AUTOSTOP'">Les passagers</button>
                        <button type="button" class="btn btn-primary" ng-model="filterUsers" btn-radio="''">Tout le monde</button>
                    </div>

		<br/>
		<div>
		<form class="form-search">
		Filtrer : 
		  <input type="text" ng-model="query" class="input-medium search-query">
		</form>
		</div>
                    <table id="searchTextResults" class="table table-hover">
                        <thead>
                            <tr>
                                <th>locomotion</th>
                                <th></th>
                                <th>Nom</th>
                                <th>Adresse</th>
                                <th>places restantes</th>
                                <th ng-show="currentSubscriber.locomotion == 'AUTOSTOP'">Monter/Descendre</th>
                                <th ng-show="currentSubscriber.locomotion == 'CAR'">Prendre/Ne plus prendre</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="subscriber in subscribers | auto:filterUsers:markers  | filter:query" ng-show="!subscriber.current" class="{{subscriber.class}}" >
                                <td><a ng-click="openSubscriberInfo(subscriber)"><img ng-src="{{subscriber.picto}}" /></a></td>
                                <td><a ng-click="createTopic(subscriber)"><i class=" icon-comment" tooltip="Démarrer une discution" ></i></a></td>
                                <td >{{subscriber.surname}} {{subscriber.name}}</td>
                                <td>{{subscriber.address.description}}</td>
                                <td>{{subscriber.car.nbPlaces - subscriber.car.passengers.length}}</td>
                                <!-- CAR -->
                                <td ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && subscriber.normalCar" >
                                    <button class="btn btn-success" type="button" ng-click="askForSeat(subscriber)" >Reserver une place</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && subscriber.currentCar" >
                                    <button class="btn btn-warning" type="button" ng-click="removePassenger(subscriber, currentSubscriber.userRef)" >Annuler ma reservation</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && subscriber.iAskHim" >
                                    <button class="btn btn-warning" type="button" ng-click="removeWaitingGuy(subscriber, currentSubscriber.userRef)" >Annuler ma demande</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'AUTOSTOP' && subscriber.heAskMeToBeInHisCar">
                                    <button class="btn btn-warning" type="button" ng-click="removePossibleCar(currentSubscriber, subscriber.userRef)" >Refuser la demande</button>
                                </td>
                                <!-- AUTOSTOP -->
                                <td ng-show="currentSubscriber.locomotion == 'CAR' && subscriber.free">
                                    <button class="btn btn-success" type="button" ng-click="proposeSeat(subscriber)" >Proposer une place</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'CAR' && subscriber.requestedByMe">
                                    <button class="btn btn-warning" type="button" ng-click="removePossibleCar(subscriber, currentSubscriber.userRef)" >Annuler ma proposition</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'CAR' && subscriber.waitingForMyCar">
                                    <button class="btn btn-warning" type="button" ng-click="removeWaitingGuy(currentSubscriber, subscriber.userRef)" >Refuser la demande</button>
                                </td>
                                <td ng-show="currentSubscriber.locomotion == 'CAR' && subscriber.inMyCar">
                                    <button class="btn btn-warning" type="button" ng-click="removePassenger(currentSubscriber, subscriber.userRef)" >-</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="span2">
            </div>
        </div>
        <div class="row-fluid">
            <div class="span2">
            </div>
            <div class="span5 well">
                <p class="nav-header">
                    Mur
                </p>
                    <textarea class="input-block-level" rows="2" ng-model="mainChat.currentMessage" ui-keypress="{13:'sendMessageToMainChat(mainChat.currentMessage)'}" ></textarea>
                <p ng-repeat="msg in mainChat.messages | orderBy: '-date' | limitTo: eltsInMainChat" class="dl-horizontalli">
                    <strong ng-show="msg.from != currentSubscriber.userRef" tooltip-placement="left" tooltip="{{msg.date | date:'à HH:mm:ss le dd/MM'}}">
                        {{refSubscribers[msg.from].surname}} {{refSubscribers[msg.from].name}} :
                    </strong>
                    <strong ng-show="msg.from == currentSubscriber.userRef" tooltip-placement="left" tooltip="{{msg.date | date:'à HH:mm:ss le dd/MM'}}">
                        Moi :
                    </strong>
                    <br/>
                    {{msg.message}}
                </p>                 li
                <p>
                    <a ng-click="eltsInMainChat = eltsInMainChat + 5 ">Plus ...</a>
                    <a class="pull-right" ng-show="eltsInMainChat > 10" ng-click="eltsInMainChat = eltsInMainChat - 5 ">... moins</a>
                </p>
            </div>
            <div class="span5 well">
                <div class="tabbable tabs-right">
                    <ul class="nav nav-tabs">
                        <li class="nav-header">Mes conversations</li>
                        <li ng-repeat="topic in topics  | orderBy: '-update'" ng-class="{'active' : topic.active}">
                            <a href="javascript:void" ng-click="loadMessages(topic)">
                                <ul class="inline">
                                    <li ng-show="chaters != currentSubscriber.userRef" ng-repeat="chaters in topic.subscribers">{{refSubscribers[chaters].surname}} {{refSubscribers[chaters].name}}, </li>
                                </ul>
                                <span ng-show="topic.alert" class="badge badge-important">message</span>
                                <small>{{topic.update | date:'HH:mm:ss le dd/MM'}}</small>
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="row-fluid">
                            <p class="nav-header">
                                Ma conversation avec : <strong ng-show="chaters != currentSubscriber.userRef" ng-repeat="chaters in chat.currentTopic.subscribers">{{refSubscribers[chaters].surname}} {{refSubscribers[chaters].name}}, </strong>
                            </p>
                            <p >
                                <a ng-click="eltsInChat = eltsInChat + 5 ">Plus ...</a>
                            </p>
                            <p ng-repeat="message in chat.messages | orderBy: 'date' | limitTo: -eltsInChat" >
                                <strong ng-show="message.from != currentSubscriber.userRef" tooltip-placement="left" tooltip="{{message.date | date:'à HH:mm:ss le dd/MM'}}">
                                    {{refSubscribers[message.from].surname}} {{refSubscribers[message.from].name}} :
                                </strong>
                                <strong ng-show="message.from == currentSubscriber.userRef" tooltip-placement="left" tooltip="{{message.date | date:'à HH:mm:ss le dd/MM'}}">
                                    Moi :
                                </strong>
                                {{message.message}}
                            </p>
                        </div>

                        <div class="row-fluid pull-right">
                            <textarea class="input-xlarge" ng-model="chat.currentMessage" ui-keypress="{13:'sendMessage(chat.currentMessage)'}" ></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
